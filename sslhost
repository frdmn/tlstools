#!/bin/bash
# ./sslhost is part of frdmn's ssltools (https://github.com/frdmn/ssltools)
# Copyright (C) 2013 Jonas Friedmann - License: Attribution-NonCommercial-ShareAlike 3.0 Unported

#####
# Settings
#####

TMPFILE=$(mktemp /tmp/sslhost-XXXXX)
SERVER=${1}   # required argument
PORT=${2:-443}  # optional argument - default: 443

#####
# DO NOT EDIT BELOW
#####

usage(){
  echo "Usage: $0 <host> [port]"
  exit 1
}

# Download temp CRT - http://serverfault.com/a/192731/176412
echo -n | openssl s_client -connect ${SERVER}:${PORT} 2>/dev/null  | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ${TMPFILE}

# Get the first line
HEAD=`head -1 ${TMPFILE}`

# Check tempfile for CRT
if [[ ! ${HEAD} =~ .*BEGIN\ CERTIFICATE.* ]]
then
  # Error :(
  echo "Couldn't get certifiacte of '${SERVER}:${PORT}'"
  usage
fi

# Calculate dates
STARTDATE=$(openssl x509 -noout -startdate -in ${TMPFILE} | awk -F= ' /notBefore/ { printf("%s\n",$NF); }')
ENDDATE=$(openssl x509 -noout -enddate -in ${TMPFILE} | awk -F= ' /notAfter/ { printf("%s\n",$NF); }')
# LANG=C => https://github.com/frdmn/ssltools/issues/1
ENDDATESECS=$(($(LANG=C date -j -f "%b %d %T %Y %Z" "${ENDDATE}" "+%s") - $(date +%s) | bc))
ENDDATEDAYS=$(echo "${ENDDATESECS}/(60*60*24)" | bc);

# Output informations
cat ${TMPFILE}
echo -e "\nHost / Port: ${SERVER}:${PORT}"
echo "Start date: ${STARTDATE}"
echo "End date: ${ENDDATE}"
echo "Days left: ${ENDDATEDAYS}"

rm ${TMPFILE}
